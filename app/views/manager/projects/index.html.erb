<% if current_user.manager? %>
        <%= link_to "New Project", new_manager_client_project_path(@client), class: "btn btn-outline-dark me-3" %>
<% end %>
<%= render 'shared/profile_modal' %>
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2><i class="bi bi-kanban"></i> Projects Listing</h2>
  <%= form_tag manager_client_projects_path(@client), method: :get, class: "ms-auto me-3 w-50" do %>
    <div class="input-group">
      <select name="search_category" class="form-select" style="max-width: 180px;">
        <option value="">All Categories</option>
        <option value="title">Project Title</option>
        <option value="user">Assigned User</option>
      </select>
      <%= text_field_tag :search_query, params[:search_query], class: "form-control", placeholder: "Search..." %>
      <button type="submit" class="btn btn-dark">
        <i class="fas fa-search text-white"></i>
      </button>
    </div>
  <% end %>
</div>
<% if current_user.manager? %>
  <div class="d-flex justify-content-center my-3">
  <%= link_to "Highest Paid", manager_client_projects_path(@client, search_category: params[:search_category], search_query: params[:search_query], sort: "highest_paid"), 
    class: "btn btn-outline-dark me-2 #{'active' if params[:sort] == 'highest_paid'}" %>
  <%= link_to "Lowest Paid", manager_client_projects_path(@client, search_category: params[:search_category], search_query: params[:search_query], sort: "lowest_paid"), 
    class: "btn btn-outline-dark #{'active' if params[:sort] == 'lowest_paid'}" %>
  </div>
<%end%>
<div class="table-responsive">
  <table class="table table-striped table-bordered align-middle">
    <thead class="table-dark">
      <tr>
        <th>Title</th>
        <th>Description</th>
        <th>Attachments</th>
        <th>Users Assigned</th>
        <% unless current_user.manager? %>
          <th>Comments</th>
          <th>Time Logs</th>
        <% end %>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% if @projects.present? %>
        <% @projects.each do |project| %>
          <tr>
            <td><strong><%= project.title %></strong></td>
            <td><%= project.description.truncate(100) %></td>
            <td>
              <% if project.attachments.attached? %>
                <ul class="list-unstyled">
                  <% project.attachments.each do |attachment| %>
                    <li>
                      <i class="bi bi-file-earmark-arrow-down"></i> 
                      <%= link_to attachment.filename, rails_blob_path(attachment, disposition: "attachment"), class: "btn btn-link" %>
                    </li>
                  <% end %>
                </ul>
              <% else %>
                <span class="text-muted">No attachments</span>
              <% end %>
            </td>
            <td>
              <% if project.users.any? %>
                <ul class="list-unstyled">
                  <% project.users.each do |user| %>
                    <li>
                      <i class="bi bi-person-circle"></i> <%= user.first_name %> <%= user.last_name %> (<%= user.email %>)
                    </li>
                  <% end %>
                </ul>
              <% else %>
                <span class="text-muted">No users assigned</span>
              <% end %>
            </td>
            <% unless current_user.manager? %>
            <td>
              <% if project.comments.any? %>
                <ul id="project_<%= project.id %>_comments" class="list-unstyled">
                  <% project.comments.last(5).each do |comment| %>
                    <li>
                      <i class="bi bi-chat-text"></i> <%= comment.content %> - 
                      <strong><%= comment.user.first_name %> <%= comment.user.last_name %></strong>
                      <% if comment.user == current_user %>
                        <%= link_to "Edit", edit_manager_client_project_comment_path(project.client, project, comment), class: "btn btn-sm btn-warning ms-2" %>
                        <%= link_to "Delete", manager_client_project_comment_path(project.client, project, comment), data: { turbo_method: :delete,turbo_confirm: "Are you sure?" }, class: "btn btn-sm btn-danger" %>
                      <% end %>
                    </li>
                  <% end %>
                </ul>
              <% else %>
                <span class="text-muted">No comments yet</span>
              <% end %>
            </td>
            <td>
              <% if project.time_logs.any? %>
                <ul id="project_<%= project.id %>_time_logs" class="list-unstyled">
                  <% project.time_logs.last(5).each do |time_log| %>
                    <li>
                      <i class="bi bi-clock"></i> <%= time_log.hours %> hrs - 
                      <strong><%= time_log.user.first_name %> <%= time_log.user.last_name %></strong>
                      <% if time_log.user == current_user %>
                        <%= link_to "Edit", edit_manager_client_project_time_log_path(project.client, project, time_log), class: "btn btn-sm btn-warning ms-2" %>
                        <%= link_to "Delete", manager_client_project_time_log_path(project.client, project, time_log),  data: { turbo_method: :delete,turbo_confirm: "Are you sure?" }, class: "btn btn-sm btn-danger" %>
                      <% end %>
                    </li>
                  <% end %>
                </ul>
              <% else %>
                <span class="text-muted">No time logs yet</span>
              <% end %>
            </td>
          <% end %>
          <td>
            <%= link_to "Show", manager_client_project_path(project.client, project), class: "btn btn-success btn-sm" %>
            <% if current_user.manager? %>
              <%= link_to "Edit", edit_manager_client_project_path(project.client, project), class: "btn btn-warning btn-sm" %>
              <%= link_to "Delete", manager_client_project_path(project.client, project), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-danger btn-sm" %>
              <%= link_to "View Payments", manager_client_project_payments_path(project.client, project), class: "btn btn-primary btn-sm" %>
              <%= link_to "Assign Users", assign_users_manager_client_project_path(project.client, project), class: "btn btn-info btn-sm" %>
              <% else %>
              <%= link_to "Add Comment", new_manager_client_project_comment_path(project.client, project), class: "btn btn-info btn-sm" %>
              <%= link_to "Add Log Time", new_manager_client_project_time_log_path(project.client, project), class: "btn btn-success btn-sm" %>
            <% end %>
          </td>
        </tr>
      <% end %>
      <% else %>
        <tr>
          <td colspan="7" class="text-center">No projects available</td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>